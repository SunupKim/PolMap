# python validators/test_deduplication.py

import pandas as pd
import sys
import os

# 프로젝트 루트 경로를 path에 추가하여 processors 모듈을 찾을 수 있게 함
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from processors.simhash_deduplicator import SimHashDeduplicator
from processors.single_news_clusterer import SingleNewsClusterer
from config import SIMHASH_TITLE_DISTANCE, SIMHASH_BODY_DISTANCE, SINGLE_TITLE_THRESHOLD, SINGLE_CONTENT_THRESHOLD

# 주의사항 : 이 모듈에서는 항상 SINGLE_THRESHOLD가 이용된다
USE_CANONICAL_ARCHIVE = False  # True면 CSV 사용
# USE_CANONICAL_ARCHIVE = True  # True면 CSV 사용

CANONICAL_ARCHIVE_PATH = "outputs/aggregated/canonical_archive.csv"

def load_test_dataframe_from_csv():
    if not os.path.exists(CANONICAL_ARCHIVE_PATH):
        raise FileNotFoundError(f"{CANONICAL_ARCHIVE_PATH} not found")

    df = pd.read_csv(CANONICAL_ARCHIVE_PATH)

    defaults = {
        "originallink": "",
        "link": "",
        "collected_at": "2026-01-01 00:00:00",
        "description": "",
    }
    for col, val in defaults.items():
        if col not in df.columns:
            df[col] = val

    return df


def run_test():
    
    # 0. 인라인 테스트 데이터 (MODE A)    
    data = [        
        # {
        #     "news_id": 0,
        #     "title": "이언주 의원, 노랑봉투법 찬성 입장 표명... 노동계 환영",
        #     "content": """이언주 의원은 오늘 노랑봉투법에 대해 찬성 입장을 공식화했습니다. 노동계는 이번 결정을 적극 환영하며 법안 통과를 촉구했습니다. 노란봉투법의 핵심은 
        #     '노동조합 및 노동관계조정법' 2조와 3조를 개정하는 것입니다. 노란봉투법이 국회를 통과하면서 사용자 범위와 노동쟁의 대상이 확대되고, 파업 노동자를 대상으로 기업의 
        #     손해배상 청구가 제한됩니다. 시행일은 2026년 3월입니다. 앞서 노란봉투법은 윤석열 정부 시절 당시 야당 주도로 국회 본회의를 통과했지만 윤석열 전 대통령이 
        #     재의요구권(거부권)을 행사, 폐기된 바 있습니다. 국민의힘이 지속적으로  노란봉투법을 반대하고 있기 때문입니다.""",
        # },
        # {
        #     "news_id": 1,
        #     "title": "이언주 '노랑봉투법 필요하다' 찬성 의사 밝혀",
        #     "content": """이언주 의원이 노랑봉투법이 필요하다며 찬성표를 던지겠다고 말했다. 노동계의 환영 목소리가 이어지며 향후 행보가 주목된다.노란봉투법의 핵심은 
        #     '노동조합 및 노동관계조정법' 2조와 3조를 개정하는 것이다. 노란봉투법이 국회를 통과하면서 사용자 범위와 노동쟁의 대상이 확대되고, 파업 노동자를 대상으로 기업의 
        #     손해배상 청구가 제한된다. 시행일은 2026년 3월이다. 앞서 노란봉투법은 윤석열 정부 시절 당시 야당 주도로 국회 본회의를 통과했지만 윤석열 전 대통령이 
        #     재의요구권(거부권)을 행사, 폐기된 바 있다.""",            
        # },
        # {
        #     "news_id": 2,
        #     "title": "이언주 '노랑봉투법 필요' 찬성의 뜻 개진",
        #     "content": """이언주 의원이 노랑봉투법이 필요하다며 찬성표를 던지겠다고 말했다. 노동계의 환영 목소리가 이어지며 향후 행보가 주목된다. 
        #     이 의원은 이날 국회에서 본회의가 열리고 해당 의안이 상정될 경우, 반대하지 않겠다고 강조했다. 노랑봉투법에 대해 그 동안 반대 목소리를 내왔던 이 의원이 갑작스레 입장을
        #     선회한 이유에 대해서는 알려지지 않았다. 이 의원은 또한 "1,2차 상법 개정의 경우 반시장이 아니라 친시장 입법"이라고 말하기도 했다.""",     
        # },
        # {
        #     "news_id": 3,
        #     "title": "이언주, '상법 개정안·노란봉투법=반시장' 송언석에 '무식의 소치'",
        #     "content": """이언주 더불어민주당 의원은 30일 송언석 국민의힘 원내대표가 상법 2차 개정안과 노란봉투법을 '반시장 입법 폭주'라고 규정한 것에 대해 '무식의 소치'라고 했다.
        #     이 의원은 이날 오전 국회에서 열린 최고위원회의에서 "반시장이라고 하는 게 무슨 말인지 뜻도 모르면서 입에 붙어서 그냥 막하는 얘기가 아닌가 하는 생각이 든다"며 이같이 말했다.
        #     그는 "1,2차 상법 개정의 경우 반시장이 아니라 친시장 입법"이라며 "코스피 5000시대, 자본시장 활성화와 선진화를 위한 정지 작업"이라고 말했다.""",            
        # },
        # {
        #     "news_id": 4,
        #     "title": "[도전 6.3지선 출마합니다] 손준기 원주시의원 라선거구",
        #     "content": """소상공인·청년·어르신 복지 강화 손준기 원주시의원 라선거구(학성·단계·우산동) 입지자는 "현장에서 들은 시민 목소리를 조례와 예산으로 연결하며 성과로 평가받는 
        #     의정활동을 해왔다"며 "단계·우산·학성동 생활 인프라 격차 해소, 소상공인 보호, 청년 일자리와 주거 안정, 어르신 돌봄 강화를 핵심 과제로 삼겠다"고 밝혔다. 
        #     특히 "약속을 지키는 책임 있는 시의원으로서 원주의 지속가능한 미래를 만들어 가겠다"고 강조했다. 
        #     권혜민 기자 △나이=40세 △정당=더불어민주당 △학력=연세대 정경대학원 경영학과 △경력=9대 시의원, 전 민주당 전국기초의원협의회장, 
        #     전 한국프랜차이즈 산업협회 강원지회 사무국장 #손준기 #원주시의원 #라선거구 #3지선 #우산동""",
        # },
        # {            
        #     "news_id": 5,
        #     "title": "[도전 6.3지선 출마합니다] 하석균 도의원 원주 5선거구",
        #     "content": """경험·연속성 바탕 현안 안정적 추진 하석균 도의원 원주 5선거구(소초면, 개운·명륜1·봉산·행구동) 입지자는 "지난 4년간 도의원으로서 지역 현안을 살피며 실천으로
        #      의정 활동을 증명해왔다"며 "그 경험과 연속성을 통해 현안을 안정적으로 이어가겠다"고 밝혔다. 특히 "30년 이상 약사 경력은 보건·복지 정책을 현실적으로 바라보는 힘이자 
        #      문제 해결의 기준이 됐다"며 "현장을 잘 알고 검증된 경험을 가진 사람, 이미 준비된 도의원을 다시 한 번 선택해 달라"고 강조했다. 
        #      △나이=63세 △정당=국민의힘 △학력=연세대 정경창업대학원 행정학과(석사) △경력=11대 도의원, 7대 원주시의원, 송호대 간호학과 겸임교수 #도의원 #하석균 #5선거구 #3지선 #행구동""",
        # },        
        
        # {
        #     "news_id": 0,
        #     "title": "'이 대통령 잘한다' 58%...민주 41%·국힘 25%",
        #     "content": """
        #     한국갤럽 정치 지지율 주간 여론조사 지선 '여당 승리' 44%·'야당 승리' 32% 이재명 대통령의 국정수행 지지율이 소폭 하락해 50% 후반대를 기록했습니다. 오늘(6일) 한국갤럽은 지난 3일부터 5일까지 전국 만 18세 이상 1,001명을 대상으로 이 대통령의 국정수행에 대한 의견을 물은 결과, 응답자의 58%가 '잘하고 있다'고 응답했다고 밝혔습니다. 이는 직전 조사(지난달 27~29일) 대비 2%포인트(p) 내린 수준입니다. 부정 평가는 29%로 전주와 동일했습니다. 12%는 '모르겠다'고 대답을 유보했습니다. 지역별로 보면 서울이 55%로 집계돼 전주보다 2%p 상승했습니다. 반면, 인경·경기는 63%로 2%p 하락했습니다. 대전·세종·충청(59%)과 광주·전라(75%)는 각각 6%p, 10%p 크게 떨어졌습니다. 대구·경북은 38%로 1%p 올랐습니다. 대통령 긍정 평가 이유는 '경제·민생'(16%), '외교'(15%), '부동산 정책'(9%), '소통'(8%), '전반적으로 잘한다'(7%), '주가 상승'(6%), '직무 능력·유능함'(5%) 순으로 꼽혔습니다. 부정 평가 이유로는 '경제·민생'(16%), '부동산 정책'(11%), '외교'와 '전반적으로 잘못한다'가 각각 8% 순으로 집계됐습니다. 한편, 정당 지지율은 더불어민주당이 41%, 국민의힘이 25%로 집계됐습니다. 민주당은 직전 조사보다 3%p 내렸고, 국민의힘은 그대로였습니다. 그 외 조국혁신당 3%, 개혁신당 2%, 진보당 1% 등의 지지율을 보였습니다. 무당층은 24%였습니다. 오는 6월 치러지는 제9회 전당대회에서 '여당 후보가 많이 당선돼야 한다'는 응답은 44%로 나왔고, '야당 후보가 더 많이 당선돼야 한다'는 응답은 32%에 그쳤습니다. 중도층만 떼어놓고 봤을 때도 '여당의 승리를 기대한다'는 응답은 42%로, 야당(29%)을 앞질렀습니다. 이번 조사는 무작위 추출된 무선전화 가상번호 조사원 인터뷰 방식으로 진행됐습니다. 표본오차는 95% 신뢰수준에서 ±3.1%p, 응답률은 12.2%(총 8,172명 통화)였습니다. 자세한 내용은 중앙선거여론조사심의위원회 홈페이지에서 확인할 수 있습니다.            
        #     """,
        # },
        # {
        #     "news_id": 1,
        #     "title": "이 대통령 지지율 58%...'장동혁 못한다' 56%·'정청래 못한다' 45%",
        #     "content": """이재명 대통령의 국정 지지율이 58%를 기록했다는 여론조사 결과가 오늘(6일) 나왔습니다. 더불어민주당과 국민의힘 양당 대표에 대한 역할 수행 평가에서는 정청래·장동혁 대표 모두 ‘잘못하고 있다’는 평가가 우세한 것으로 나타났습니다. 한국갤럽에 따르면, 이 대통령 직무 수행 평가 조사 결과 응답자의 58%가 ‘잘하고 있다’고 답했습니다. 지난주 대비 2%P 하락한 수치입니다. 중도층의 경우 60%가 ‘잘하고 있다’고 응답한 반면, ‘잘못하고 있다’는 부정평가는 29%로 지난주 조사와 동일했습니다. 이 대통령의 직무 수행을 긍정 평가한 이유로는 ‘경제/민생’이 16%로 가장 높게 나타났습니다. 이 외에는 △’외교’(15%) △‘부동산 정책’(9%) △‘소통’(8%) △‘전반적으로 잘한다’(7%) 등 순입니다. 여야 당대표 평가에선 정청래 민주당 대표의 부정 평가가 45%, 장동혁 국민의힘 대표의 부정 평가가 56%로 집계됐습니다. 정 대표에 대한 긍정 평가는 전체 유권자 기준 38%, 민주당 지지층 기준 64%입니다. 이는 작년 9월 기준 43%, 77%에서 모두 하락한 결과입니다. 장 대표에 대한 긍정 평가는 전체 유권자 기준과 국민의힘 지지층 기준으로 각각 27%, 57%였고, 작년 9월 30%, 69%에서 각각 하락했습니다. 정당 지지도는 민주당이 3%포인트 하락한 41%, 국민의힘은 지난주와 동일한 25%로 집계됐습니다. 이어 조국혁신당 3%, 개혁신당 2%, 진보당1% 등의 순입니다. 지지하는 정당이 없는 무당층은 26%로 나타났습니다. 한편 이번 여론조사는 한국갤럽이 지난 3~5일 전국 만 18세 이상 1,001명을 대상으로 실시했습니다. 조사 방법은 무작위 추출된 무선전화 가상번호에 전화 조사원 인터뷰 방식으로 진행됐습니다. 표본오차는 95% 신뢰수준에 ±3.1%p, 응답률은 12.2%입니다. 자세한 내용은 중앙선거여론조사심의위원회 홈페이지 참조하면 됩니다.""",
        # },
        # {
        #     "news_id": 2,
        #     "title": "민주당 41%·국민의힘 25%…민주 3%p↓·국힘 변동 없어[한국갤럽]",
        #     "content": """조국혁신당 3%·개혁신당 2%·진보당 1%…무당층 26% [서울=뉴시스] 이승재 기자 = 더불어민주당과 국민의힘의 정당 지지율이 각각 41%, 25%를 기록했다는 여론조사 결과가 6일 나왔다. 여론조사 전문회사 한국갤럽은 지난 3~5일(2월 첫째 주) 전국 만 18세 이상 유권자 1001명을 대상으로 정당 지지도를 조사한 결과 이같이 집계됐다고 밝혔다. 조국혁신당과 개혁신당은 각각 3%, 2%를 기록했다. 진보당은 1%이며, 지지하는 정당이 없는 무당층은 26%다. 직전 조사(1월 다섯째 주)와 비교해 민주당 지지율은 3%포인트 하락했고, 국민의힘 지지율은 변동 없었다. 성향별로는 진보층의 76%가 민주당을, 보수층의 59%가 국민의힘을 지지했다. 중도층의 경우 민주당은 38%, 국민의힘은 17%, 특정 정당을 지지하지 않는 유권자는 37%로 조사됐다. 양당 정당 대표 역할 수행 평가에서는 정청래 민주당 대표의 경우 긍정과 부정 평가가 각각 38%, 45%로 집계됐다. 장동혁 국민의힘 대표는 긍정 평가가 27%, 부정 평가가 56%로 나타났다. 지방선거 결과에 관한 조사에서는 '여당 후보가 많이 당선돼야 한다'가 44%, '야당 후보가 많이 당선돼야 한다'가 32%로 집계됐다. 나머지 24%는 의견을 유보했다. 이번 조사는 무작위 추출된 무선전화 가상번호에 전화 조사원 인터뷰(CATI) 방식으로 진행됐다. 응답률은 12.2%이며 표본오차는 95% 신뢰 수준에 ±3.1%포인트다. 자세한 내용은 중앙선거여론조사심의위원회 또는 한국갤럽 홈페이지를 참조하면 된다．""",
        #     },
        # {
        #     "news_id": 3,
        #     "title": "정청래 ‘43 → 38%’, 장동혁 ‘30 → 27%’… 여야 내홍에 긍정평가 일제 하락",
        #     "content": """정청래 더불어민주당 대표와 장동혁 국민의힘 대표에 대한 긍정 평가가 지난해 9월 조사 결과와 비교해 각각 5%포인트, 3%포인트 하락했다는 한국갤럽 조사 결과가 6일 나왔다. 정 대표는 조국혁신당과의 합당 논란, 장 대표는 한동훈 전 대표와의 갈등 탓에 리더십 위기를 겪고 있다는 해석이 나온다. 한국갤럽이 지난 3∼5일 전국 만 18세 이상 유권자 1001명을 대상으로 진행한 2월 1주 조사(95% 신뢰수준에 표본오차 ±3.1%포인트)에 따르면 정 대표에 대한 긍정 평가는 38%, 부정 평가는 45%로 나타났다. 지난해 9월 4주 조사 때는 긍정 평가가 43%, 부정 평가가 44%였다. 긍정 평가가 하락한 배경에는 검찰개혁 등 정청래 체제 출범 후 계속된 당·청 이견에 더해 최근 조국혁신당과의 합당 논란이 영향을 줬다는 분석이 나온다. 장 대표에 대한 긍정률은 27%, 부정률은 56%로 나타났다. 지난 조사 결과 때는 각각 30%, 51%였다. 장 대표의 긍정 평가가 저조한 데는 강성 지지층 위주 당 운영이 영향을 미친 것으로 풀이된다. 임기 초반 지지층 결집에 주력하면서 계엄 사과와 윤석열 전 대통령 절연 등에 적극적으로 나서지 못했다는 분석이다. 2012년 이후 민주당의 당 대표 평가에서 정 대표는 지난 조사에서 본인이 받은 긍정 평가율(43%)에 이어 두 번째로 높은 평가를 받았다. 반면 국민의힘 장 대표는 김기현 당시 당 대표(26%)에 이어 두 번째로 낮은 평가를 받았다. 지금까지 유권자로부터 가장 후하게 평가받은 정당의 당 대표는 박근혜 당시 새누리당 비상대책위원장(52%)이고, 가장 박하게 평가받은 인물은 문재인 당시 새정치민주연합 대표(18%)였다. 정당 지지율은 민주당 41%, 국민의힘 25%, 조국혁신당 3%, 개혁신당 2%, 진보당 1% 순으로 나타났다. 자세한 사항은 중앙선거여론조사심의위원회 홈페이지 참조.            
        #     """,
        # },        

        {
            "news_id": 4,
            "title": "'이 대통령 잘한다' 58%...민주 41%·국힘 25%",
            "content": "'이 대통령 잘한다' 58%...민주 41%·국힘 25%",            
        },
        {
            "news_id": 5,
            "title": "민주당 41%·국민의힘 25%…민주 3%p↓·국힘 변동 없어",
            "content": "'이 대통령 잘한다' 58%...민주 41%·국힘 25%",            
        },
        {
            "news_id": 6,
            "title": "합당 ‘대외비 문건’ 파문에 민주당 내홍 확산",
            "content": "합당 ‘대외비 문건’ 파문에 민주당 내홍 확산",            
        },
        {
            "news_id": 7,
            "title": "與 ‘합당 대외비 문건’ 논란에 “과거 사례 정리”…정청래, 유출 엄...",
            "content": "與 ‘합당 대외비 문건’ 논란에 “과거 사례 정리”…정청래, 유출 엄...",            
        },    
        {
            "news_id": 8,
            "title": "강득구 ""당원 주권 아닌 당대표 주권...국민이 의심""",
            "content": "더불어민주당 강득구 최고위원은 조국혁신당과의 합당을 제안한 정청래 대표를 겨냥해, '당원 주권을 얘기하지만, '당 대표 주권'이라고 비판했습니다. 강 최고위원은 오늘(7일) SNS에 합당 논의를 두고 당원과 국민이 지도자를 의심하기 시작했다며, 더 이상은 안 된다고 적었습니다. 이어 합당 논의가 통합이 아니라 분열을 만들고 있다면서, 정 대표가 멈추지 않으면 여기까지라고 경고했습니다. 또 정 대표가 특정 커뮤니티에서 이른바 '좌표'를 찍은 뒤 2만 개 가까운 문자 폭탄을 받았다며, 이는 야만이고 폭력이라고 지적했습니다. 강 최고위원은 조국혁신당 조국 대표를 향해서도 이번 사태에 일정 부분 책임이 있다면서, 지금까지의 모든 논의 과정과 경위를 있는 그대로 공개하라고 촉구했습니다. 이와 함께 국민 다수가 원하지 않는, 원칙 없는 속도전은 개혁이 아니라 개악이고 그 결과는 공멸일 수 있다고 덧붙였습니다. ※ '당신의 제보가 뉴스가 됩니다' [카카오톡] YTN 검색해 채널 추가 [전화] 02-398-8585 [메일] social@ytn.co.kr",                       
        },    
        {
            "news_id": 9,
            "title": "與강득구 ""정청래 멈추지 않으면 여기까지…좌표 찍혀 문자폭탄 2만개""",
            "content": """야만이고 폭력…통합 아니라 분열 만들어"" [데일리안 = 맹찬호 기자] 비당권파 강득구 더불어민주당 최고위원이 정청래 민주당 대표가 조국혁신당과의 합당을 추진하는 것을 강하게 비판하면서 ""정 대표가 멈추지 않으면 여기까지다""라고 밝혔다. 강 최고위원은 7일 페이스북에 ""요새 참 힘들다. 몸무게가 4㎏이나 빠졌다. 입안이 헐었다. 2만개 가까운 문자 폭탄을 받았다""며 이같이 호소했다. 그는 ""당 대표가 특정 커뮤니티에서 좌표를 찍고 특정 유트브에서 제 전화번호를 공개한 이후에 훨씬 더 심해졌다""며 ""이것은 야만이고 폭력""이라고 강조했다. 최근 민주당 내부에선 혁신당과의 합당 여부를 둘러싸고 강득구·이언주 최고위원 등 친명계 인사들과 정 대표가 정면 충돌하는 양상이다. 강 최고위원은 ""정치를 시작한 이후에 나름 원칙을 지켜왔다. 이낙연 의원이 당 대표 시절 박근혜 사면을 얘기했을 때 공개적으로 반대했고 이낙연과 싸웠다""며 ""그때도 공격을 두려워하지 않았다""고 주장했다. 이어 ""당원과 국민이 지도자를 의심하기 시작한다. 정 대표는 당원 주권이라고 얘기하지만 대표 주권""이라며 ""더 이상은 안 된다. 통합이 아니라 분열을 만들고 있다""고 덧붙였다.""",            
        },           
    ]

    # ----------------------------------------
    # 데이터 소스 분기 (유일한 진입점)
    # ----------------------------------------
    if USE_CANONICAL_ARCHIVE:
        df = load_test_dataframe_from_csv()
        print(f"[TEST MODE] canonical_archive.csv ({len(df)} rows)")
    else:
        df = pd.DataFrame(data)
        print(f"[TEST MODE] inline data ({len(df)} rows)")

    # SingleNewsClusterer.process() 및 CanonicalNewsPolicy에 필요한 컬럼 추가
            
    if "originallink" not in df.columns:
        df["originallink"] = ""
    if "pubDate" not in df.columns:
        df["pubDate"] = "2026-01-01 00:00:00"
    if "link" not in df.columns:
        df["link"] = ""
    if "collected_at" not in df.columns:
        df["collected_at"] = "2026-01-01 00:00:00"
    if "description" not in df.columns:
        df["description"] = ""
    
    # 1단계: SimHash 테스트 (Near-Duplicate 제거용)
    sh_dedup = SimHashDeduplicator(title_distance=SIMHASH_TITLE_DISTANCE, body_distance=SIMHASH_BODY_DISTANCE)
    kept_df, removed_df = sh_dedup.deduplicate(df)

    if not removed_df.empty:
        for _, row in removed_df.iterrows():
            print(f"삭제됨: {row['title']}")
    print("-" * 40)

    # 2단계: SingleNewsClusterer와 동일한 그룹핑 로직 (OR 조건 + Canonical 선정)
    title_threshold = SINGLE_TITLE_THRESHOLD
    content_threshold = SINGLE_CONTENT_THRESHOLD    
    
    print(f"2단계: SingleNewsClusterer.process() (Title > {title_threshold}, Content > {content_threshold})")

    clusterer = SingleNewsClusterer(
        title_threshold=title_threshold,
        content_threshold=content_threshold,
        test_mode = True
    )   

    df_result, stats = clusterer.process(kept_df.copy(), keyword="test")
    print(f"\n--- [최종 SingleNewsClusterer 그룹핑 결과] ---")
    out_cols = ["cluster_id", "title_id", "body_id", "is_canon", "replaced_by", "title"]
    print(df_result[[c for c in out_cols if c in df_result.columns]])
    print("\n[통계]", stats)

if __name__ == "__main__":
    run_test()